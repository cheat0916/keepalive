name: Keepalive

on:
  schedule:
    - cron: '*/10 * * * *' # æ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-24.04

    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Restore fail_counts cache
        uses: actions/cache@v3
        with:
          path: fail_counts.txt
          key: fail-counts-Linux-v1
          restore-keys: |
            fail-counts-Linux-

      - name: Run Keepalive script
        run: |
          set -e

          URLS=(
            "https://nezha-cheat0916.koyeb.app/"
            # å¯æ·»åŠ æ›´å¤š URL
          )

          MAX_RETRY=2
          FAIL_FILE="fail_counts.txt"
          LAST_REPORT_FILE=".last_daily_report"
          DAYS_KEEP=7
          PARALLEL=5
          MAX_FAIL_MSG=5

          [ -f "$FAIL_FILE" ] || > "$FAIL_FILE"
          [ -f "$LAST_REPORT_FILE" ] || > "$LAST_REPORT_FILE"

          NOW=$(date +%s)
          TODAY=$(date '+%Y-%m-%d')

          declare -A FAIL_COUNTS
          while IFS=" " read -r url count timestamp; do
            timestamp=${timestamp:-$NOW}
            DIFF=$(( (NOW - timestamp) / 86400 ))
            [ $DIFF -le $DAYS_KEEP ] && FAIL_COUNTS["$url"]=$count
          done < "$FAIL_FILE"

          IS_DAILY_REPORT=false
          HOUR_BEIJING=$(( $(date -u +%H) + 8 ))
          LAST_SENT=$(cat "$LAST_REPORT_FILE" 2>/dev/null || echo "")
          if [ $HOUR_BEIJING -ge 9 ] && [ $HOUR_BEIJING -le 11 ] && [ "$LAST_SENT" != "$TODAY" ]; then
            IS_DAILY_REPORT=true
            echo "$TODAY" > "$LAST_REPORT_FILE"
          fi

          REPORT="ğŸ“‹ *æ¯æ—¥å¥åº·ç®€æŠ¥*\næ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\n\n"
          FAIL_MESSAGES=()
          FAIL_COUNT=0

          check_url() {
            local url="$1"
            local status
            local retry=0
            status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            while [ "$status" != "200" ] && [ $retry -lt $MAX_RETRY ]; do
              sleep 5
              status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              ((retry++))
            done

            if [ "$status" != "200" ]; then
              FAIL_COUNTS["$url"]=$(( ${FAIL_COUNTS["$url"]:-0} + 1 ))
              echo "âŒ $url failed (${FAIL_COUNTS["$url"]} æ¬¡è¿ç»­å¤±è´¥)"
              REPORT+="âŒ $url  (çŠ¶æ€ç : $status, è¿ç»­å¤±è´¥ ${FAIL_COUNTS["$url"]} æ¬¡)\n"

              if [ "${FAIL_COUNTS["$url"]}" -ge 3 ] && [ "$IS_DAILY_REPORT" = false ]; then
                ((FAIL_COUNT++))
                if [ $FAIL_COUNT -le $MAX_FAIL_MSG ]; then
                  FAIL_MESSAGES+=("âš ï¸ ä¿æ´»å¤±è´¥ï¼ˆè¿ç»­ ${FAIL_COUNTS["$url"]} æ¬¡ï¼‰\nURL: $url\nçŠ¶æ€ç : $status\næ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')")
                fi
              fi
            else
              FAIL_COUNTS["$url"]=0
              echo "âœ… $url is UP"
              REPORT+="âœ… $url  (çŠ¶æ€ç : $status)\n"
            fi
          }

          # å¹¶è¡Œæ£€æµ‹ URL
          semaphores=0
          for url in "${URLS[@]}"; do
            check_url "$url" &
            ((semaphores++))
            if [ $semaphores -ge $PARALLEL ]; then
              wait
              semaphores=0
            fi
          done
          wait

          # ä¿å­˜ fail_counts
          > "$FAIL_FILE"
          for url in "${!FAIL_COUNTS[@]}"; do
            printf "%s %d %d\n" "$url" "${FAIL_COUNTS[$url]}" "$NOW" >> "$FAIL_FILE"
          done

          # å‘é€å¤±è´¥æé†’ï¼ˆTelegram å‡ºé”™ä¸å½±å“è„šæœ¬ï¼‰
          if [ ${#FAIL_MESSAGES[@]} -gt 0 ]; then
            REMAINING=$((FAIL_COUNT - MAX_FAIL_MSG))
            MSG_TEXT=$(printf "%s\n\n" "${FAIL_MESSAGES[@]}")
            [ $REMAINING -gt 0 ] && MSG_TEXT+="...è¿˜æœ‰ $REMAINING æ¡å¤±è´¥æœªæ˜¾ç¤º"
            set +e
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$MSG_TEXT" \
              -d parse_mode="Markdown"
            set -e
          fi

          # å‘é€æ¯æ—¥å¥åº·æŠ¥å‘Šï¼ˆTelegram å‡ºé”™ä¸å½±å“è„šæœ¬ï¼‰
          if [ "$IS_DAILY_REPORT" = true ]; then
            set +e
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$REPORT" \
              -d parse_mode="Markdown"
            set -e
          fi

      - name: Save fail_counts cache
        uses: actions/cache@v3
        with:
          path: fail_counts.txt
          key: fail-counts-Linux-v1
