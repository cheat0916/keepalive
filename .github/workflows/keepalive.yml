name: Keep Multiple Apps Alive with Smart Alerts & Daily Report

on:
  schedule:
    # ÊØè10ÂàÜÈíüÊâßË°å‰∏ÄÊ¨°‰øùÊ¥ª
    - cron: "*/10 * * * *"
    # ÊØèÂ§©Êó©‰∏ä 08:00 UTC+8 ÂèëÈÄÅÂÅ•Â∫∑ÁÆÄÊä•
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      SEND_SUCCESS_LOG: false # true ‰∏∫ÊØèÊ¨°ÊàêÂäü‰πüÂèëÈÄÅ Telegram
    steps:
      - name: Restore fail counts
        uses: actions/cache@v4
        with:
          path: fail_counts.txt
          key: fail-counts

      - name: Ping All URLs
        shell: bash
        run: |
          set +e   # ÂÖ≥Èó≠ÈùûÈõ∂ÈÄÄÂá∫Á†ÅÂº∫Âà∂ÁªàÊ≠¢

          # --- Áª¥Êä§ URL ÂàóË°®ÔºåÊñ∞Â¢û/Âà†Èô§Âè™ÈúÄÊîπËøôÈáå ---
          URLS="https://nezha-cheat0916.koyeb.app/ https://151515.com/"

          # Â¶ÇÊûúÁºìÂ≠òÊñá‰ª∂‰∏çÂ≠òÂú®ÂàôÂàõÂª∫
          if [ ! -f fail_counts.txt ]; then
            > fail_counts.txt
          fi

          declare -A FAIL_COUNTS
          while IFS=" " read -r url count; do
            FAIL_COUNTS["$url"]=$count
          done < fail_counts.txt

          IS_DAILY_REPORT=false
          if [ "$(date -u +%H:%M)" == "00:00" ]; then
            IS_DAILY_REPORT=true
          fi

          REPORT="üìã *ÊØèÊó•ÂÅ•Â∫∑ÁÆÄÊä•*\nÊó∂Èó¥: $(date '+%Y-%m-%d %H:%M:%S')\n\n"

          for url in $URLS; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")

            if [ "$STATUS" != "200" ]; then
              sleep 5
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
            fi

            if [ "$STATUS" != "200" ]; then
              FAIL_COUNTS["$url"]=$(( ${FAIL_COUNTS["$url"]:-0} + 1 ))
              echo "‚ùå $url failed (${FAIL_COUNTS["$url"]} times in a row)"
              
              if [ "${FAIL_COUNTS["$url"]}" -ge 3 ] && [ "$IS_DAILY_REPORT" = false ]; then
                MESSAGE="‚ö†Ô∏è ‰øùÊ¥ªÂ§±Ë¥•ÔºàËøûÁª≠ ${FAIL_COUNTS["$url"]} Ê¨°Ôºâ\nURL: $url\nÁä∂ÊÄÅÁ†Å: $STATUS\nÊó∂Èó¥: $(date '+%Y-%m-%d %H:%M:%S')"
                curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                     -d chat_id="${TELEGRAM_CHAT_ID}" \
                     -d text="$MESSAGE" \
                     -d parse_mode="Markdown"
              fi
              REPORT+="‚ùå $url  (Áä∂ÊÄÅÁ†Å: $STATUS, ËøûÁª≠Â§±Ë¥• ${FAIL_COUNTS["$url"]} Ê¨°)\n"
            else
              FAIL_COUNTS["$url"]=0
              echo "‚úÖ $url is UP"
              REPORT+="‚úÖ $url  (Áä∂ÊÄÅÁ†Å: $STATUS)\n"

              if [ "$SEND_SUCCESS_LOG" = "true" ] && [ "$IS_DAILY_REPORT" = false ]; then
                MESSAGE="‚úÖ $url is UP\nÁä∂ÊÄÅÁ†Å: $STATUS\nÊó∂Èó¥: $(date '+%Y-%m-%d %H:%M:%S')"
                curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                     -d chat_id="${TELEGRAM_CHAT_ID}" \
                     -d text="$MESSAGE" \
                     -d parse_mode="Markdown"
              fi
            fi
          done

          # ‰øùÂ≠òÂ§±Ë¥•Ê¨°Êï∞
          > fail_counts.txt
          for url in $URLS; do
            echo "$url ${FAIL_COUNTS["$url"]}" >> fail_counts.txt
          done

          # ÊØèÊó•ÁÆÄÊä•
          if [ "$IS_DAILY_REPORT" = true ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                 -d chat_id="${TELEGRAM_CHAT_ID}" \
                 -d text="$REPORT" \
                 -d parse_mode="Markdown"
          fi

      - name: Save fail counts
        uses: actions/cache@v4
        with:
          path: fail_counts.txt
          key: fail-counts
