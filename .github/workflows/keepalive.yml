name: Keepalive

on:
  schedule:
    - cron: '*/15 * * * *' # æ¯ 15 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch: # å¯æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  keepalive:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Keepalive script
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -e

          URLS=(
            "https://nezha-cheat0916.koyeb.app/"
            # å¯ä»¥æ·»åŠ æ›´å¤š URL
          )

          MAX_RETRY=2
          FAIL_FILE="fail_counts.txt"
          DAYS_KEEP=7

          # å¦‚æœç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º
          if [ ! -f "$FAIL_FILE" ]; then
            > "$FAIL_FILE"
          fi

          # å½“å‰æ—¶é—´æˆ³
          NOW=$(date +%s)

          # å°†å¤±è´¥æ¬¡æ•°åŠ è½½åˆ°å…³è”æ•°ç»„ï¼Œåªä¿ç•™æœ€è¿‘ 7 å¤©å†…çš„è®°å½•
          declare -A FAIL_COUNTS
          while IFS=" " read -r url count timestamp; do
            if [ -z "$timestamp" ]; then
              timestamp=$NOW
            fi
            DIFF=$(( (NOW - timestamp) / 86400 ))
            if [ $DIFF -le $DAYS_KEEP ]; then
              FAIL_COUNTS["$url"]=$count
            fi
          done < "$FAIL_FILE"

          # åˆ¤æ–­æ˜¯å¦ç”Ÿæˆæ¯æ—¥æŠ¥å‘Šï¼ˆä¸­å›½æ—¶é—´ 10:00 å¯¹åº” UTC 02:00ï¼‰
          IS_DAILY_REPORT=false
          if [ "$(date -u +%H:%M)" == "02:00" ]; then
            IS_DAILY_REPORT=true
          fi

          REPORT="ğŸ“‹ *æ¯æ—¥å¥åº·ç®€æŠ¥*\næ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\n\n"

          # å¹¶å‘æ£€æŸ¥æ¯ä¸ª URL
          for url in "${URLS[@]}"; do
          (
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            RETRY=0
            while [ "$STATUS" != "200" ] && [ $RETRY -lt $MAX_RETRY ]; do
              sleep 5
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              ((RETRY++))
            done

            if [ "$STATUS" != "200" ]; then
              FAIL_COUNTS["$url"]=$(( ${FAIL_COUNTS["$url"]:-0} + 1 ))
              echo "âŒ $url failed (${FAIL_COUNTS["$url"]} times in a row)"

              # Telegram å¤±è´¥æé†’ï¼ˆéæ—¥æŠ¥ï¼‰
              if [ "${FAIL_COUNTS["$url"]}" -ge 3 ] && [ "$IS_DAILY_REPORT" = false ]; then
                MESSAGE="âš ï¸ ä¿æ´»å¤±è´¥ï¼ˆè¿ç»­ ${FAIL_COUNTS["$url"]} æ¬¡ï¼‰\nURL: $url\nçŠ¶æ€ç : $STATUS\næ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
                curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                  -d chat_id="${TELEGRAM_CHAT_ID}" \
                  -d text="$MESSAGE" \
                  -d parse_mode="Markdown"
              fi

              REPORT+="âŒ $url  (çŠ¶æ€ç : $STATUS, è¿ç»­å¤±è´¥ ${FAIL_COUNTS["$url"]} æ¬¡)\n"
            else
              FAIL_COUNTS["$url"]=0
              echo "âœ… $url is UP"
              REPORT+="âœ… $url  (çŠ¶æ€ç : $STATUS)\n"
            fi
          ) &
          done
          wait

          # ä¿å­˜å¤±è´¥æ¬¡æ•°å’Œæ—¶é—´æˆ³
          > "$FAIL_FILE"
          for url in "${!FAIL_COUNTS[@]}"; do
            printf "%s %d %d\n" "$url" "${FAIL_COUNTS[$url]}" "$NOW" >> "$FAIL_FILE"
          done

          # æ¯æ—¥ç®€æŠ¥å‘é€
          if [ "$IS_DAILY_REPORT" = true ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$REPORT" \
              -d parse_mode="Markdown"
          fi
