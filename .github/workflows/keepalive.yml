#!/usr/bin/env bash
set -e

# åœ¨è¿™é‡Œæ·»åŠ ä½ è¦ä¿æ´»çš„ URL
URLS=(
  "https://nezha-cheat0916.koyeb.app/"
  # "https://another-url.com/" # å¯ä»¥éšæ—¶æ·»åŠ 
)

MAX_RETRY=2   # æ¯ä¸ª URL æœ€å¤§é‡è¯•æ¬¡æ•°
FAIL_FILE="fail_counts.txt"

# å¦‚æœç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º
if [ ! -f "$FAIL_FILE" ]; then
  > "$FAIL_FILE"
fi

# å°†å¤±è´¥æ¬¡æ•°åŠ è½½åˆ°å…³è”æ•°ç»„
declare -A FAIL_COUNTS
while IFS=" " read -r url count; do
  FAIL_COUNTS["$url"]=$count
done < "$FAIL_FILE"

# åˆ¤æ–­æ˜¯å¦ç”Ÿæˆæ¯æ—¥æŠ¥å‘Šï¼ˆä¸­å›½æ—¶é—´ 10:00 å¯¹åº” UTC 02:00ï¼‰
IS_DAILY_REPORT=false
if [ "$(date -u +%H:%M)" == "02:00" ]; then
  IS_DAILY_REPORT=true
fi

REPORT="ğŸ“‹ *æ¯æ—¥å¥åº·ç®€æŠ¥*\næ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\n\n"

# å¹¶å‘æ£€æŸ¥æ¯ä¸ª URL
for url in "${URLS[@]}"; do
(
  STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url")
  RETRY=0
  while [ "$STATUS" != "200" ] && [ $RETRY -lt $MAX_RETRY ]; do
    sleep 5
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url")
    ((RETRY++))
  done

  if [ "$STATUS" != "200" ]; then
    FAIL_COUNTS["$url"]=$(( ${FAIL_COUNTS["$url"]:-0} + 1 ))
    echo "âŒ $url failed (${FAIL_COUNTS["$url"]} times in a row)"
    
    # Telegram å¤±è´¥æé†’ï¼ˆéæ—¥æŠ¥ï¼‰
    if [ "${FAIL_COUNTS["$url"]}" -ge 3 ] && [ "$IS_DAILY_REPORT" = false ]; then
      MESSAGE="âš ï¸ ä¿æ´»å¤±è´¥ï¼ˆè¿ç»­ ${FAIL_COUNTS["$url"]} æ¬¡ï¼‰\nURL: $url\nçŠ¶æ€ç : $STATUS\næ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
      curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d text="$MESSAGE" \
        -d parse_mode="Markdown"
    fi

    REPORT+="âŒ $url  (çŠ¶æ€ç : $STATUS, è¿ç»­å¤±è´¥ ${FAIL_COUNTS["$url"]} æ¬¡)\n"
  else
    FAIL_COUNTS["$url"]=0
    echo "âœ… $url is UP"
    REPORT+="âœ… $url  (çŠ¶æ€ç : $STATUS)\n"
  fi
) &
done
wait

# ä¿å­˜å¤±è´¥æ¬¡æ•°
> "$FAIL_FILE"
for url in "${!FAIL_COUNTS[@]}"; do
  printf "%s %d\n" "$url" "${FAIL_COUNTS[$url]}" >> "$FAIL_FILE"
done

# æ¯æ—¥ç®€æŠ¥å‘é€
if [ "$IS_DAILY_REPORT" = true ]; then
  curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
    -d chat_id="${TELEGRAM_CHAT_ID}" \
    -d text="$REPORT" \
    -d parse_mode="Markdown"
fi
